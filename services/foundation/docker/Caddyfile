# Global options
{
    admin 0.0.0.0:2019
    
    # Enable debug mode in development
    {$DEBUG:false}
    
    # Automatic HTTPS
    email {$CADDY_EMAIL:admin@rankmybrand.ai}
    
    # ACME CA (use staging for testing)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main domain configuration
{$DOMAIN:localhost} {
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        
        # XSS protection
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        
        # Remove server header
        -Server
        
        # Add custom headers
        X-Service "RankMyBrand.ai GEO Platform"
    }
    
    # Rate limiting
    rate_limit {
        zone api {
            key {remote_host}
            events 100
            window 1m
        }
    }
    
    # Logging
    log {
        output stdout
        format json
        level INFO
    }
    
    # Health check endpoint (no auth required)
    handle /health {
        respond "OK" 200
    }
    
    # Metrics endpoint (internal only)
    handle /metrics {
        @internal {
            remote_ip 172.20.0.0/16 127.0.0.1 ::1
        }
        respond @internal "Access denied" 403
        reverse_proxy prometheus:9090
    }
    
    # API Gateway routes
    
    # Foundation service
    handle /api/foundation/* {
        rate_limit api
        reverse_proxy foundation:3000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Health checking
            health_uri /health
            health_interval 30s
            health_timeout 5s
            health_status 200
            
            # Circuit breaker
            fail_duration 30s
            max_fails 3
            
            # Load balancing (when scaled)
            lb_policy round_robin
            lb_try_duration 5s
            lb_try_interval 250ms
        }
    }
    
    # AI Response Monitor service
    handle /api/ai-monitor/* {
        rate_limit api
        reverse_proxy ai-monitor:3001 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            fail_duration 30s
            max_fails 3
        }
    }
    
    # Intelligence Engine service
    handle /api/intelligence/* {
        rate_limit api
        reverse_proxy intelligence:3002 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            fail_duration 30s
            max_fails 3
        }
    }
    
    # Action Center service
    handle /api/actions/* {
        rate_limit api
        reverse_proxy actions:3003 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            fail_duration 30s
            max_fails 3
        }
    }
    
    # GEO Calculator service (Python/FastAPI)
    handle /api/geo/* {
        rate_limit api
        reverse_proxy geo-calculator:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            fail_duration 30s
            max_fails 3
        }
    }
    
    # Web Crawler service
    handle /api/crawler/* {
        rate_limit api
        reverse_proxy web-crawler:3002 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            health_uri /health
            health_interval 30s
            fail_duration 30s
            max_fails 3
        }
    }
    
    # Dashboard (Next.js)
    handle /dashboard* {
        reverse_proxy dashboard:3004 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # WebSocket support for real-time updates
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    
    handle @websockets {
        reverse_proxy dashboard:3004
    }
    
    # Grafana (monitoring)
    handle /grafana* {
        uri strip_prefix /grafana
        reverse_proxy grafana:3000
    }
    
    # ChromaDB (vector store)
    handle /chromadb* {
        @internal {
            remote_ip 172.20.0.0/16 127.0.0.1 ::1
        }
        respond @internal "Access denied" 403
        
        uri strip_prefix /chromadb
        reverse_proxy chromadb:8000
    }
    
    # BullBoard (job monitoring)
    handle /jobs* {
        @internal {
            remote_ip 172.20.0.0/16 127.0.0.1 ::1
        }
        respond @internal "Access denied" 403
        
        uri strip_prefix /jobs
        reverse_proxy bullboard:3000
    }
    
    # Uptime Kuma (service monitoring)
    handle /uptime* {
        uri strip_prefix /uptime
        reverse_proxy uptime-kuma:3001
    }
    
    # Default route
    handle {
        respond "RankMyBrand.ai GEO Platform API Gateway" 200
    }
}

# Admin API (internal only)
:2019 {
    @internal {
        remote_ip 172.20.0.0/16 127.0.0.1 ::1
    }
    
    handle @internal {
        metrics /metrics
        reverse_proxy /config/* caddy:2019
    }
    
    handle {
        respond "Unauthorized" 401
    }
}